{?xml version="1.0"?}
{Jelly}
	
	{!-- Message Type_Action "Send" --}
		{Type_Action}
			{Type}Message{/Type}
			{Name}Send{/Name}
			{Content}
				<!-- No content --> 
			{/Content}
			{Code}
				<!-- Message Type_Action "Send" -->
				
				<!-- Disambiguate -->
				[Set Current_Item to Current_Action.Target /]
				 
				[If Current_Item.Variables.Recipient]				
					[Then]
						[PHP]
							// Add content
							$subject = '[Format as "PHP Single Quoted String"][Current_Item.Subject no_wrap/][/Format]';
							$body = '[Format as "PHP Single Quoted String"][Current_Item.Variables.Body no_wrap/][/Format]';
					
							// Add From, BCC 
							$from = 'services@'.array_shift((explode(".",$_SERVER['HTTP_HOST']))).'.better.space';

							$fromName = '[Format as "PHP Single Quoted String"][1 Site from Database no_wrap][Name no_wrap/][/1][/Format] (via Better)';
							$bcc = array('services@better.space');
					
							// Add recipient
							$to = array('[Format as "PHP Single Quoted String"][Current_Item.Variables.Recipient.Email_Address no_wrap /][/Format]', '[Format as "PHP Single Quoted String"][Current_Item.Variables.Recipient.Name no_wrap /][/Format]');
					
							// Add sender
							$replyTo = '[Format as "PHP Single Quoted String"][Current_Item.Variables.Sender.Email_Address no_wrap /][/Format]', '[Format as "PHP Single Quoted String"][Current_Item.Variables.Sender.Name no_wrap /][/Format]';

							// Send 
							$emailResp = sendGridEmail($to, $from, $subject, $body, $replyTo, $fromName);
							if(emailResp\['error'\])\{
								echo 'Message could not be sent. Error: '. $emailResp\['error'\];
							\}
						[/PHP]
					[/Then]
					[Else]	
						No recipient provided for message.
					[/Else]					
				[/If]
			{/Code}
		{/Type_Action}
	
{/Jelly}