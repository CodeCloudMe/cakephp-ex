{?xml version="1.0"?}
{Jelly}
	
	{!-- Item Type_Action "Email Group" --}
		{Type_Action}
			{Type}Item{/Type}
			{Name}Email Group{/Name}
			{Content}
				<!-- TODO - merge with Email Team --> 
				[Set Current_Action.Variables.Visible = False/]
				[Member][Set Current_Action.Variables.Visible = True/][/Member]

				[If Current_Action.Variables.Visible]
					<div class="Window Send_Email_Window">
						<a href="#" class="Close_Button" onclick="Jelly.Interface.Close_Top_Window(); return false;" style="float:right;"><img class="iconic" data-src="/jelly/libraries/iconic/svg/smart/x-thin.svg"></a>

						<span class="Header">
							Email [Current_Action.Target.Name/] Group
						</span>

						[Action as Result/]

						[Set Action.Variables.Team_Has_Valid_Recipients to False/]
						[If Property_Alias]
							[1 Current_Action.Target.[Property_Alias no_wrap/] where Activated and Email_Address exists and Email_Address is not "" and Allow_Community_Members_To_Contact_Me and ID is not Current_Session.User.ID]
								[Set Action.Variables.Team_Has_Valid_Recipients to True/]
							[/]
						[/If]		

						[If Action.Variables.Team_Has_Valid_Recipients]
							[Then]
								[Input "Hidden" with Name = "Property Alias", Value = Property_Alias/]
				
								<span class="Recipients">
									<label>To:</label>

									<div class="Input_Wrapper Big_List Grid Tiny">
										[Current_Action.Target.[Property_Alias no_wrap/] where Activated and Email_Address exists and Email_Address is not "" and Allow_Community_Members_To_Contact_Me and ID is not Current_Session.User.ID iterator_classes "Big_List_Items" item_classes "Big_List_Item Hover"]
											[Set Current_Member to this /]

											<span id="[Current_Action.Namespace no_wrap /]_Recipient_[Current_Member.ID no_wrap /]_Value_Input_Finder">
												[Input "Hidden" with Name = "Recipient [Current_Member.ID no_wrap /]", Value = "1"/]
											</span>

											<!-- Details -->
											<a class="Big_List_Item_Details Selected" id="[Current_Action.Namespace no_wrap /]_Recipient_[Current_Member.ID no_wrap /]" href="#" onclick="[Format as "Single Line Code"]
													Jelly.jQuery(this).toggleClass('Selected');
													Jelly.jQuery('#' + this.id + '_Value_Input_Finder input').val(Jelly.jQuery(this).hasClass('Selected') & 1);
													return false;
												[/Format]">
			
												<!-- Cover Image -->
												<span class="Big_List_Item_Cover">
													[Current_Member as Cover /]
												</span>
	
												<span class="Big_List_Item_Name">
													[Current_Member.Name /]
												</span>
	
												<span class="Big_List_Item_Check">âˆš</span>
											</a>
										[/]		
									</div>		
								</span>
				
								<span class="Author">
									<!-- Set sender to current user, or site owner as fallback --> 
									[If Current_Session.User]
										[Then][Set Current_Action.Variables.Sender = Current_Session.User/][/Then]
										[Else][1 Site from Database][Set Current_Action.Variables.Sender to Site.Owner/][/1][/Else]
									[/If]		
									[Input "Hidden" with Name = "Sender", Value = Current_Action.Variables.Sender/]

									<label>CC:</label><span>[Current_Action.Variables.Sender.Email_Address/]</span>
								</span>

								<span class="Subject">
									[Input "Text Field" with Name = "Subject", Placeholder="Subject"/]
								</span>

								<span class="Message">
									[Input "Inline Text" with Name = "Body"/]

									[Set Current_Action.Variables.Signature to "&#x1f4e8; Sent from [Site.Name/] via Better!"/] 
									[Input "Hidden" with Name = "Signature", Value = Current_Action.Variables.Signature/]
									<div class="Signature">[Current_Action.Variables.Signature/]</div>
								</span>

								<span class="Execute">
									[Link to Execute]Send[/Link]
								</span>		
							[/Then]
							[Else]
								<div style="padding:25px;">
									There are no members of this group to contact this way.
								</div>
								<span class="Execute">
									<!-- close link -->
									<a href="javascript:Jelly.Interface.Close_Top_Window();" class="Button">Close</a>
								</span>
							[/Else]
						[/If]
					</div>
				[/If]
			{/Content}
			{Code}
				[If not Form.Subject]
					[Show Error for "Subject"]Please enter a subject[/Show]
				[/If]

				[If not Form.Body]
					[Show Error for "Body"]Please enter a message[/Show]
				[/If]

				[If not Form.Sender.Email_Address]
					[Show Error]Complete your profile with your email address to send group messages.[/Show]
				[/If]

				[If not Form.Property_Alias]
					[Show Error]Something went wrong.  This message was not sent.[/Show]
				[/If]

				[If not Form.Error]
					[Set Current_Action.Variables.Traversed = False/]
					[Current_Action.Target.[Form.Property_Alias no_wrap/] where Activated and Email_Address exists and Email_Address is not "" and Allow_Community_Members_To_Contact_Me and ID is not Current_Session.User.ID no_wrap]
						[Set Current_Member to This/]
						[If Form.Recipient_[Current_Member.ID no_wrap/]][Set Current_Action.Variables.Traversed = True/][/If]
					[/]
					[If not Current_Action.Variables.Traversed]
						[Show Error]Please select at least one recipient.[/Show Error]
					[/If]
				[/If]

				[If not Form.Error]
					[PHP]
						

						// Add content
						$Subject = '[Format as "PHP Single Quoted String"]\[[Current_Action.Target.Name no_wrap/]\] [Form.Subject no_wrap/][/Format]';
						$Body = '[Format as "PHP Single Quoted String"][Form.Body no_wrap/]<br/>[Form.Signature no_wrap/][/Format]';





						// Get from
							$From = array(
								'Name' => '[Format as "PHP Single Quoted String"][Form.Sender.Name no_wrap /][/Format]',
								'Email_Address' => '[Format as "PHP Single Quoted String"][Form.Sender.Email_Address no_wrap /][/Format]'
							);
			
							// Get recipient
							

								// Add recipient
							
						$To = array();


						[Current_Action.Target.[Form.Property_Alias no_wrap/] where Activated and Email_Address exists and Email_Address is not "" and Allow_Community_Members_To_Contact_Me and ID is not Current_Session.User.ID no_wrap]
							[Set Current_Member to This/]
							[If Form.Recipient_[Current_Member.ID no_wrap/]]
								
								array_push($To, array(
									'Name' => '[Format as "PHP Single Quoted String"][Current_Member.Name no_wrap /][/Format]',
									'Email_Address' => '[Format as "PHP Single Quoted String"][Current_Member.Email_Address no_wrap /][/Format]'
								));


							[/If]
						[/]




							// Get sender
							$Reply_To = array(
								'Name' => '[Format as "PHP Single Quoted String"][Form.Sender.Name no_wrap /][/Format]',
								'Email_Address' => '[Format as "PHP Single Quoted String"][Form.Sender.Email_Address no_wrap /][/Format]'
							);
	
							// Get BCC
							$BCC = array(
								'Email_Address' => 'services@better.space'
							);
	
							// Send message
							try 
							\{
								$Email_Response = sendGridEmail($Subject, $Body, $From, $To, $Reply_To, $BCC);
								if($Email_Response\['error'\])
								\{
									die('Error: Message could be sent. '. $Email_Response\['error'\]);
								\}
							\}
							catch (exception $Exception) 
							\{
								echo ('Error: Message could be sent.');
								traverse($Exception->getMessage());
								die();
							\}





					[/PHP]

					[External_Script]
						[Block "Email Sent Confirmation"]
							[Go to This into "[Form.Calling_Namespace no_wrap/]"/]
						[/Block]
					[/External_Script]
				[/If]
			{/Code}
		{/Type_Action}
	
{/Jelly}