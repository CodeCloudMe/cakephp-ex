{?xml version="1.0"?}
{Jelly}
	
	{!-- Action "Forgot Password" --}
		{Action}
			{Name}Forgot Password{/Name}
			{Content}
				<span class="Page_Item">
					<h1>Forgot Password</h1>
					<span class="Block" style="margin-bottom: 25px;">
						<span class="Block" style="width: 50%;">
							<div class="Member_Login">
								<!-- Name -->
								<span class="Input_Row_B" style="width:232px;">
									<label>Name/Email:</label>
									[Input "Text Field" with Name = "Username" /]
								</span>
			
								<!-- Execute -->
								<span class="Input_Row_B" style="width:232px;">
									[Link to Execute with Class = "Button"]Email me Password Reset Link[/Link]
								</span>
				
								<!-- Result --> 
								<span class="Input_Row_B" style="width:232px;">
									[Current_Action as "Result"/]
								</span>
							</div>
						</span>
					</span>
				</span>
			{/Content}
			{Code}
				[If Form.Username does not exist or Form.Username = ""]
					[Show Error for "Username"]Please enter a username.[/Show]
				[/If]

				[If not Form.Error]
					[User from Database where Alias = Globals.Form.Username or Name = Globals.Form.Username or Email_Address = Globals.Form.Username]
						[Then]
							[Set Current_User to this /]
							[New Reset_Password_Code]
								[Set New_Reset_Password_Code to this /]
				
								[Set New_Reset_Password_Code.Name to "[PHP]return substr(md5(microtime()),rand(0,26), 24);[/PHP]" /]
				
								[Set New_Reset_Password_Code.User to Current_User /]
				
								[Save New_Reset_Password_Code /]
				
								<!-- Email -->
								[PHP]
									require_once 'jelly/php/libraries/phpmailer/PHPMailerAutoload.php';
	
									// TODO: confirm email
	
									$Mail_Sender = new PHPMailer;
	
									// TODO: move SMTP information to database
									$Mail_Sender->Host = 'wkw5-lvvb.accessdomain.com';
									$Mail_Sender->Port = 587;
									$Mail_Sender->Username = 'sender@better.space';
									$Mail_Sender->Password = 'S3nder3.';
	
									// SMTP Settings
									$Mail_Sender->isSMTP();
									$Mail_Sender->SMTPAuth = true;
									$Mail_Sender->SMTPSecure = 'tls';
				
									// Sender and Recipients
									// TODO: Generic sender, etc.
									$Mail_Sender->From = 'services@better.space';
									$Mail_Sender->FromName = '[Format as "PHP Single Quoted String"][Site.Name no_wrap /][/Format] (via Better)';
									$Mail_Sender->addAddress('[Format as "PHP Single Quoted String"][Current_User.Email_Address no_wrap /][/Format]', '[Format as "PHP Single Quoted String"][Current_User.Name no_wrap /][/Format]');
									$Mail_Sender->addReplyTo('services@better.space', 'Better');
									$Mail_Sender->addBCC('services@better.space');
				
									// HTML message
									$Mail_Sender->isHTML(true);
				
									// Message subject and body
									$Mail_Sender->Subject = 'Reset Your Password';
									$Mail_Sender->Body    = <<<EOT
<body style="margin: 25px; padding: 0px;">
	<div style="font-family: Arial; font-size: 14px;">
		<div style="margin-bottom: 25px; padding: 5px; background-color: black; color: white; display: inline-block;">
			Password Reset
		</div>

		<div style="margin-bottom: 25px;">
			<div style="margin-bottom: 25px;">
				<!-- Name -->
				<div class="Name" style="font-weight: bold; margin-bottom: 10px;">
					Hi [Current_User.Name /]
				</div>

				<!--  -->
				<div class="Time" style="margin-bottom: 10px;">
					Someone requested a password reset for your account.  Hopefully, that was you! 
				</div>
	
				<!-- Page -->
				<div class="Time" style="margin-bottom: 10px;">
					<div class="Time" style="margin-bottom: 2px;">
						Please click the link below to set a new password. 
					</div>
					<div class="Time" style="margin-bottom: 5px;">
						<a href="http://[PHP]return $_SERVER\['HTTP_HOST'\];[/PHP]/Action/Reset_Password:Code=[New_Reset_Password_Code.Name No_Wrap/]">http://[PHP]return $_SERVER\['HTTP_HOST'\];[/PHP]/Action/Reset_Password:Code=[New_Reset_Password_Code.Name No_Wrap/]</a>
					</div>
				</div>
			</div>
		</div>	
		<div>
			Thanks!
		</div>
	</div>
</body>
EOT;
									// $Mail_Sender->AltBody = 'This is the body in plain text for non-HTML mail clients';
				
									// Try sending the message
									if(!$Mail_Sender->send())
										echo 'Message could not be sent. Error: ' . $Mail_Sender->ErrorInfo;
								[/PHP]
				
								A reset link was emailed to you.
							[/New]
						[/Then]
						[Else]
							[Show Error for "Username"]Could not find the user.[/Show]
						[/Else]
					[/User]
				[/If]
			{/Code}
		{/Action}
	
{/Jelly}