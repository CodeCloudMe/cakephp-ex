{?xml version="1.0"?}
{Jelly}
	
	{!-- Action "Email Other" --}
		{Action}
			{Name}Email Other{/Name}
			{Content}
				[Set Current_Action.Variables.Visible = False/]
				[Admin][Set Current_Action.Variables.Visible = True/][/Admin]

				[If Current_Action.Variables.Visible]
					<div class="Window Send_Email_Window">
						<a href="#" class="Close_Button" onclick="Jelly.Interface.Close_Top_Window(); return false;" style="float:right;"><img class="iconic" data-src="/jelly/libraries/iconic/svg/smart/x-thin.svg"></a>

						<span class="Header">
							Email General Contributors
						</span>

						[Action as Result/]

						[Set Action.Variables.Team_Has_Valid_Recipients to False/]
						[User from Database where Activated and Email_Address exists and Email_Address is not "" and ID is not Current_Session.User.ID][1 Team][Else][Set Action.Variables.Team_Has_Valid_Recipients to True/][/Else][/1 Team][/User]

						[If Action.Variables.Team_Has_Valid_Recipients]
							[Then]
								<span class="Recipients">
									<label>To:</label>

									<div class="Input_Wrapper Big_List Grid Tiny">
										[User from Database where Activated and Email_Address exists and Email_Address is not "" and ID is not Current_Session.User.ID iterator_classes "Big_List_Items" item_classes "Big_List_Item Hover"][Set Current_Member to this /][1 Team][Else]
											<span id="[Current_Action.Namespace no_wrap /]_Recipient_[Current_Member.ID no_wrap /]_Value_Input_Finder">
												[Input "Hidden" with Name = "Recipient [Current_Member.ID no_wrap /]", Value = "1"/]
											</span>

											<!-- Details -->
											<a class="Big_List_Item_Details Selected" style="overflow:hidden" id="[Current_Action.Namespace no_wrap /]_Recipient_[Current_Member.ID no_wrap /]" href="#" onclick="[Format as "Single Line Code"]
													Jelly.jQuery(this).toggleClass('Selected');
													Jelly.jQuery('#' + this.id + '_Value_Input_Finder input').val(Jelly.jQuery(this).hasClass('Selected') & 1);
													return false;
												[/Format]">

												<!-- Cover Image -->
												<span class="Big_List_Item_Cover">
													[Current_Member as Cover /]
												</span>

												<span class="Big_List_Item_Name">
													[Current_Member.Name /]
												</span>

												<span class="Big_List_Item_Check">âˆš</span>
											</a>
										[/Else][/Team][/User]		
									</div>		
								</span>

								<span class="Author">
									<!-- Set sender to current user, or site owner as fallback --> 
									[If Current_Session.User]
										[Then][Set Current_Action.Variables.Sender = Current_Session.User/][/Then]
										[Else][1 Site from Database][Set Current_Action.Variables.Sender to Site.Owner/][/1][/Else]
									[/If]		
									[Input "Hidden" with Name = "Sender", Value = Current_Action.Variables.Sender/]

									<label>CC:</label><span>[Current_Action.Variables.Sender.Email_Address/]</span>
								</span>

								<span class="Subject">
									[Input "Text Field" with Name = "Subject", Placeholder="Subject"/]
								</span>

								<span class="Message">
									[Input "Inline Text" with Name = "Body"/]

									[Set Current_Action.Variables.Signature to "&#x1f4e8; Sent from [Site.Name/] via Better!"/] 
									[Input "Hidden" with Name = "Signature", Value = Current_Action.Variables.Signature/]
									<div class="Signature">[Current_Action.Variables.Signature/]</div>
								</span>

								<span class="Execute">
									[Link to "/Action/Copy_Email_Addresses_For_Other" into Action.Namespace with Class ="Button Right"]
											Copy Email Addresses
									[/Link]
									[Link to Execute with Class = "Right"]Send[/Link]
								</span>		
							[/Then]
							[Else]
								<div style="padding:25px;">
									There are no members of this group to contact this way.
								</div>
								<span class="Execute">
									<!-- close link -->
									<a href="javascript:Jelly.Interface.Close_Top_Window();" class="Button">Close</a>
								</span>
							[/Else]
						[/If]
					</div>
				[/If]
			{/Content}
			{Code}
				[If not Form.Subject]
					[Show Error for "Subject"]Please enter a subject[/Show]
				[/If]

				[If not Form.Body]
					[Show Error for "Body"]Please enter a message[/Show]
				[/If]

				[If not Form.Sender.Email_Address]
					[Show Error]Complete your profile with your email address to send team messages.[/Show]
				[/If]

				[Set Current_Action.Variables.Traversed = False/]
				[User from Database where Activated and Email_Address exists and Email_Address is not "" and ID is not Current_Session.User.ID][Set Current_Member to this /][1 Team][Else]
					[If Form.Recipient_[Current_Member.ID no_wrap/]][Set Current_Action.Variables.Traversed = True/][/If]
				[/Else][/Team][/User]
				[If not Current_Action.Variables.Traversed]
					[Show Error]Please select at least one recipient.[/Show Error]
				[/If]

				[If not Form.Error]
					[PHP]
						require_once 'jelly/php/libraries/phpmailer/PHPMailerAutoload.php';

						$Mail_Sender = new PHPMailer;

						// TODO: move SMTP information to database
						$Mail_Sender->Host = 'wkw5-lvvb.accessdomain.com';
						$Mail_Sender->Port = 587;
						$Mail_Sender->Username = 'sender@better.space';
						$Mail_Sender->Password = 'S3nder3.';

						// SMTP Settings
						$Mail_Sender->isSMTP();
						$Mail_Sender->SMTPAuth = true;
						$Mail_Sender->SMTPSecure = 'tls';		

						// Content type settings
						$Mail_Sender->CharSet = 'UTF-8';
						$Mail_Sender->isHTML(true);

						// Add content
						$Mail_Sender->Subject = '[Format as "PHP Single Quoted String"][Form.Subject no_wrap/][/Format]';
						$Mail_Sender->Body = '[Format as "PHP Single Quoted String"][Form.Body no_wrap/]<br/>[Form.Signature no_wrap/][/Format]';

						// Add From, BCC 
						$Mail_Sender->From = 'services@better.space';
						$Mail_Sender->FromName = '[Format as "PHP Single Quoted String"][1 Site from Database no_wrap][Name no_wrap/][/1][/Format] (via Better)';
						$Mail_Sender->addBCC('services@better.space');

						// Add sender
						$Mail_Sender->addReplyTo('[Format as "PHP Single Quoted String"][Form.Sender.Email_Address no_wrap /][/Format]', '[Format as "PHP Single Quoted String"][Form.Sender.Name no_wrap /][/Format]');		
						$Mail_Sender->addCC('[Format as "PHP Single Quoted String"][Form.Sender.Email_Address no_wrap /][/Format]', '[Format as "PHP Single Quoted String"][Form.Sender.Name no_wrap /][/Format]');

						// Add recipient
						[User from Database where Activated and Email_Address exists and Email_Address is not "" and ID is not Current_Session.User.ID][Set Current_Member to this /][1 Team][Else]
							[If Form.Recipient_[Current_Member.ID no_wrap/]]
								$Mail_Sender->addAddress('[Format as "PHP Single Quoted String"][Current_Member.Email_Address no_wrap /][/Format]', '[Format as "PHP Single Quoted String"][Current_Member.Name no_wrap /][/Format]');
							[/If]
						[/Else][/Team][/User]

						// Send 
						if(!$Mail_Sender->send())
							echo 'Message could not be sent. Error: ' . $Mail_Sender->ErrorInfo;
					[/PHP]

					[External_Script]
						[Block "Email Sent Confirmation"]
							[Go to This into "[Form.Calling_Namespace no_wrap/]"/]
						[/Block]
					[/External_Script]
				[/If]
			{/Code}
		{/Action}
{/Jelly}